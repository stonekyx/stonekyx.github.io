---
layout: post
title: "Recent bugfixes in EGUI"
date: 2014-04-28 22:22:19 +0800
comments: true
categories: 
---

最近在解决别人的一些问题的时候，发现EGUI里的两个小bug。

首先是绘制图片的时候会莫名其妙地崩溃。图片是要绘制在gd里的，而gd有一个独立的工作区域，它与图片的长宽无关。估计以往测试图片没出过问题，是因为gd的工作区域被设置得比图片小。这次有人把它设置成全屏后再画，就直接崩溃了。

调试之后发现是`engine_draw_bitmap`里循环坐标的时候，没有检查图片的边界，而只检查了gd的工作区域边界。

------------------

另外一个问题则比较纠结，一张85x64x24的彩色图片，被绘制出来以后是灰色的，而且中间有条纹状的颜色错乱。

这个很果断没有当场调试出来。之后发现是bitmap的格式处理有问题。像素矩阵中每一行的第一个字节都应该要对齐到32位，这是bitmap的规定。之前的代码直接用坐标算出要取的字节位置，所以会漏掉一些对齐位。对于这张24位的图片，每一行会错开一字节，所以出错的颜色呈现有规律的条纹。

比较规范的写法好像是一次读取一行，所以不会遇到这种问题。而EGUI里是一次性读取整个文件。

-----------------

想到之前bitmap的头部信息结构体也出现过字节对齐的bug，写这个部分的人C语言基础可能还不够扎实吧。
