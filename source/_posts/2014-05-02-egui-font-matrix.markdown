---
layout: post
title: "EGUI Font Matrix"
date: 2014-05-02 19:17:10 +0800
comments: true
categories: 
---

Font Matrix是EGUI表示字体的一种形式。由于要减少对外部库的使用，没办法加载freetype这样的库来读取ttf，所以在EGUI内部直接用二进制点阵的方式保存字体。根据不同的字体大小，共有13个Font Matrix。

之前的写法是直接将13个Font Matrix作为C数组写在代码里，然后编译进二进制库（graph模块，所以是libgraph.so）。但这样会使得代码量显得非常大（超过70000行），而且编译耗时也很长。

对这个部分的改进开始于commit 1118d03，具体做法是将编码Font Matrix的C数组全部作为二进制数据输出到`font_matrix_*.dat`里，然后在服务器端第一次显示文字时读取这些dat文件。这些数组的空间仍然在代码中进行了定义，所以这将近400k的数据会出现在二进制库的BSS段，并在加载时在内存中分配并清零，直到读取数据文件，其中才会出现数据。

另一种可能的写法是将数组变成指针，然后在读取文件前分配空间。这样可以为不需要字体的情况减少内存使用。

消去之后的代码量为45507行，通过`find . \( -name '*.c' -o -name '*.h' \) -exec cat {} \; | wc -l`命令统计。当然，代码量什么的只是自我满足而已。
